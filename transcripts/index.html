<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>JSON-Based HTML + Script Loader</title>
</head>
<body>
  <p>Loading remote JSONâ€¦</p>

  <script>
    (async () => {
      const getParam = name => new URLSearchParams(location.search).get(name);
      const decodeBase64 = str => {
        try {
          return atob(str.trim());
        } catch (e) {
          console.error("Base64 decode failed:", e);
          return null;
        }
      };

      const encodedUrl = getParam("data");
      if (!encodedUrl) {
        document.body.innerHTML = "<h2>Error: Missing ?data= parameter.</h2>";
        return;
      }

      const targetUrl = decodeURIComponent(atob(encodedUrl));

      try {
        const response = await fetch(targetUrl);
        const json = await response.json();

        if (!json.html64) {
          document.body.innerHTML = "<h2>Error: JSON missing 'html64'.</h2>";
          return;
        }

        const decodedHTML = decodeBase64(json.html64);
        if (!decodedHTML) {
          document.body.innerHTML = "<h2>Error decoding html64.</h2>";
          return;
        }

        // Replace page content
        document.open();
        document.write(decodedHTML);
        document.close();

        // Inject script after DOM loads
        window.addEventListener("DOMContentLoaded", () => {
          if (json.script64) {
            const decodedScript = decodeBase64(json.script64);
            if (decodedScript) {
              const script = document.createElement("script");
              script.textContent = decodedScript;
              document.body.appendChild(script);
            }
          }
        });
      } catch (err) {
        document.body.innerHTML = `<h2>Error loading or parsing JSON.</h2><pre>${err}</pre>`;
        console.error(err);
      }
    })();
  </script>
</body>
</html>
