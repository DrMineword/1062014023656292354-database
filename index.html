<script>
  const b64 = document.getElementById("data-b64").textContent.trim();
  const jsonStr = atob(b64);
  const data = JSON.parse(jsonStr);

  const table = document.getElementById("leaderboard");
  const thead = table.querySelector("thead tr");
  const tbody = table.querySelector("tbody");

  const excludeFields = ["discord", "dc_id", "created_at", "last_edit", "last_edit_ms"];
  const keys = Object.keys(data[0]).filter(key => !excludeFields.includes(key));
  
  let currentSort = { key: null, dir: 1 };

  function renderTable(sortKey = null, direction = 1) {
    tbody.innerHTML = "";

    let sorted = [...data];
    if (sortKey) {
      sorted.sort((a, b) => {
        let A = a[sortKey];
        let B = b[sortKey];

        A = typeof A === "string" ? A.toLowerCase() : A;
        B = typeof B === "string" ? B.toLowerCase() : B;

        if (typeof A === "number" && typeof B === "number") return (A - B) * direction;
        if (!isNaN(parseFloat(A)) && !isNaN(parseFloat(B))) return (parseFloat(A) - parseFloat(B)) * direction;

        if (Array.isArray(A) && Array.isArray(B)) return (A.length - B.length) * direction;
        if (A < B) return -1 * direction;
        if (A > B) return 1 * direction;
        return 0;
      });
    }

    for (const item of sorted) {
      const row = document.createElement("tr");
      for (const key of keys) {
        const cell = document.createElement("td");
        let val = item[key];

        if (key === "item_found" && Array.isArray(val)) {
          if (val.length > 1) {
            const preview = document.createElement("span");
            preview.textContent = `ðŸ”Ž [${val.length} items]`;
            preview.style.cursor = "pointer";
            preview.style.color = "#007acc";
            preview.style.textDecoration = "underline";

            const list = document.createElement("ul");
            list.style.margin = "0.5em 0 0 0";
            list.style.paddingLeft = "1em";
            list.style.display = "none";
            list.style.listStyle = "disc";
            list.style.fontSize = "0.9em";

            val.forEach(v => {
              const li = document.createElement("li");
              li.textContent = v;
              list.appendChild(li);
            });

            preview.addEventListener("click", () => {
              list.style.display = list.style.display === "none" ? "block" : "none";
            });

            cell.appendChild(preview);
            cell.appendChild(list);
          } else {
            cell.textContent = val[0] || "";
          }
        } else {
          cell.textContent = Array.isArray(val) ? val.join(", ") : val;
        }

        row.appendChild(cell);
      }
      tbody.appendChild(row);
    }
  }

  function renderHeader() {
    thead.innerHTML = "";
    keys.forEach(key => {
      const th = document.createElement("th");
      const label = document.createElement("span");
      label.textContent = key;

      const arrow = document.createElement("span");
      arrow.className = "sort-arrow";

      if (currentSort.key === key) {
        arrow.textContent = currentSort.dir === 1 ? " â«" : " â¬";
      }

      th.appendChild(label);
      th.appendChild(arrow);

      th.addEventListener("click", () => {
        if (currentSort.key === key) {
          currentSort.dir *= -1;
        } else {
          currentSort.key = key;
          currentSort.dir = 1;
        }
        renderHeader();
        renderTable(currentSort.key, currentSort.dir);
      });

      thead.appendChild(th);
    });
  }

  renderHeader();
  renderTable();
</script>
