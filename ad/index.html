<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Watch to Earn</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      background: #f4f4f4;
    }
    #content {
      margin-top: 30px;
    }
    img, video {
      max-width: 100%;
      border-radius: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <h1>üé• Watch this ad to claim your reward</h1>
  <div id="content">Loading ad...</div>

  <script>
    async function loadAd() {
      try {
        const response = await fetch('https://drmineword.github.io/1062014023656292354-database/ad/index.json');
        const ad = await response.json();

        const contentDiv = document.getElementById('content');
        const byteCharacters = atob(ad.file_base64);
        const byteArrays = [];

        for (let i = 0; i < byteCharacters.length; i++) {
          byteArrays.push(byteCharacters.charCodeAt(i));
        }

        const mimeType = ad.type.toLowerCase() === 'video' ? 'video/mp4' : 'image/gif';
        const blob = new Blob([new Uint8Array(byteArrays)], { type: mimeType });
        const url = URL.createObjectURL(blob);

        const isVideo = ad.type.toLowerCase() === 'video';
        const media = document.createElement(isVideo ? 'video' : 'img');
        media.src = url;

        contentDiv.innerHTML = '';
        contentDiv.appendChild(media);

        if (isVideo) {
          media.controls = false;
          media.autoplay = true;
          media.playsInline = true;
          media.disablePictureInPicture = true;
          media.addEventListener('contextmenu', e => e.preventDefault());
          media.onended = () => sendWebhook(ad);
        } else {
          media.onload = () => {
            setTimeout(() => sendWebhook(ad), 5000); // wait 5 seconds
          };
        }

      } catch (error) {
        document.getElementById('content').innerText = '‚ùå Failed to load ad.';
        console.error(error);
      }
    }

    function getIdParam() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id') || 'unknown';
    }

    function sendWebhook(ad) {
      const id = getIdParam();
      const webhookURL = atob(atob(ad.webhook)); // Double base64 decode

      const payload = {
        id,
        reward: ad.reward
      };

      const formData = new FormData();
      const jsonBlob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      formData.append('file', jsonBlob, 'reward_data.json');
      formData.append('content', `üéÅ User watched ad. Reward: ${ad.reward}`);

      fetch(webhookURL, {
        method: 'POST',
        body: formData
      })
      .then(() => {
        document.getElementById('content').innerHTML = '<h2>‚úÖ Reward sent via Discord!</h2>';
      })
      .catch((err) => {
        console.error(err);
        document.getElementById('content').innerHTML = '<h2>‚ùå Failed to send to Discord.</h2>';
      });
    }

    loadAd();
  </script>
</body>
</html>
